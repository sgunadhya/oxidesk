<div id="message-view" class="flex-1 flex flex-col min-w-0 h-full relative" x-data="conversationManager()">
    <!-- Header -->
    <div class="px-8 py-6 bg-white/5 border-b border-white/5">
        <div class="flex justify-between items-start">
            <div class="flex-1">
                <h2 class="text-2xl font-bold text-white oxi-heading truncate" title="{{ conversation.subject }}">
                    {{ conversation.subject }}
                </h2>
                <div class="flex items-center gap-3 mt-1">
                    <span class="text-xs font-bold text-oxi-accent uppercase tracking-widest">{{ conversation.contact_name
                        }}</span>
                    <span class="w-1 h-1 rounded-full bg-white/20"></span>
                    <span class="text-xs text-gray-500">{{ conversation.status|upper }}</span>
                </div>

                <!-- Tags Section -->
                <div class="flex items-center gap-2 mt-3 flex-wrap">
                    <template x-for="tag in tags" :key="tag.id">
                        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold border"
                            :style="{
                                backgroundColor: tag.color + '20',
                                borderColor: tag.color + '40',
                                color: tag.color
                            }">
                            <span x-text="tag.name"></span>
                            <button @click="removeTag(tag.id)" class="ml-1 hover:opacity-70 transition-opacity">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                        </span>
                    </template>

                    <!-- Add Tag Button -->
                    <div class="relative">
                        <button @click="showPicker = !showPicker"
                            class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-white/5 text-gray-400 hover:bg-white/10 hover:text-white border border-white/10 transition-all duration-200">
                            <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            <span>Add Tag</span>
                        </button>

                        <!-- Tag Picker Dropdown -->
                        <div x-show="showPicker" @click.away="showPicker = false" x-cloak
                            x-transition:enter="transition ease-out duration-200"
                            x-transition:enter-start="opacity-0 transform scale-95"
                            x-transition:enter-end="opacity-100 transform scale-100"
                            x-transition:leave="transition ease-in duration-150"
                            x-transition:leave-start="opacity-100 transform scale-100"
                            x-transition:leave-end="opacity-0 transform scale-95"
                            class="absolute left-0 mt-2 w-64 oxi-glass rounded-xl shadow-2xl z-50 overflow-hidden border border-white/10">

                            <!-- Search Input -->
                            <div class="p-3 border-b border-white/10">
                                <input x-model="search" type="text" placeholder="Search tags..."
                                    class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-sm text-white placeholder-gray-500 focus:outline-none focus:border-oxi-accent transition-colors duration-200">
                            </div>

                            <!-- Tag List -->
                            <div class="max-h-60 overflow-y-auto custom-scrollbar">
                                <template x-if="availableTags.length === 0">
                                    <div class="px-4 py-6 text-center text-sm text-gray-500">
                                        No tags available
                                    </div>
                                </template>

                                <template x-for="tag in availableTags" :key="tag.id">
                                    <button @click="addTag(tag.id)"
                                        class="w-full flex items-center gap-3 px-4 py-3 hover:bg-white/5 transition-colors duration-200 text-left">
                                        <span class="w-3 h-3 rounded-full" :style="{ backgroundColor: tag.color }"></span>
                                        <span class="text-sm text-white" x-text="tag.name"></span>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        <!-- Actions Row -->
        <div class="flex items-center gap-4">
            <!-- SLA Badge -->
            <template x-if="sla !== null">
                <div x-data="slaTimer(sla)"
                    class="flex items-center gap-2 px-3 py-2 rounded-xl border"
                    :class="{
                        'bg-oxi-success/10 border-oxi-success/30 text-oxi-success': secondsRemaining > 3600,
                        'bg-oxi-warning/10 border-oxi-warning/30 text-oxi-warning': secondsRemaining <= 3600 && secondsRemaining > 0,
                        'bg-oxi-danger/10 border-oxi-danger/30 text-oxi-danger': secondsRemaining <= 0
                    }">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="text-xs font-bold" x-text="formatTime()"></span>
                </div>
            </template>

            <!-- Assignment Dropdown -->
            <div class="relative">
                <select hx-patch="/inbox/conversations/{{ conversation.id }}/assign" hx-trigger="change" hx-swap="none"
                    name="agent_id"
                    class="appearance-none bg-white/5 border border-white/10 text-white text-sm rounded-xl focus:ring-oxi-accent focus:border-oxi-accent block w-full px-4 py-2 pr-10 transition-all duration-200">
                    <option value="">Unassigned</option>
                    {% for agent in agents %}
                    <option value="{{ agent.id }}" {% if let Some(assignee)=conversation.assigned_user_id %} {% if
                        assignee.as_str()==agent.id %}selected{% endif %} {% endif %}>
                        {{ agent.first_name }}
                    </option>
                    {% endfor %}
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
            </div>

            <!-- Resolve/Reopen Button -->
            {% if conversation.status != "resolved" && conversation.status != "closed" %}
            <button hx-post="/inbox/conversations/{{ conversation.id }}/resolve" hx-target="#message-view"
                class="px-4 py-2 bg-oxi-success/20 text-oxi-success hover:bg-oxi-success hover:text-white rounded-xl transition-all duration-200 border border-oxi-success/30 font-bold text-sm shadow-[0_0_15px_var(--oxi-success-glow)]">
                Resolve
            </button>
            {% else %}
            <button hx-post="/inbox/conversations/{{ conversation.id }}/open" hx-target="#message-view"
                class="px-4 py-2 bg-white/5 text-white hover:bg-white/10 rounded-xl transition-all duration-200 border border-white/10 font-bold text-sm">
                Re-open
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Message Stream -->
    <div id="message-list" class="flex-1 overflow-y-auto p-8 space-y-8 flex flex-col custom-scrollbar">
        {% for msg in messages %}
        <div class="flex {% if msg.is_agent %}justify-end{% else %}justify-start{% endif %}">
            <div class="max-w-xl group relative">
                <div class="mb-2 flex items-center gap-2 {% if msg.is_agent %}justify-end{% endif %}">
                    <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">{{ msg.sender_name
                        }}</span>
                    <span class="text-[10px] text-gray-600">{{ msg.created_at|truncate(16) }}</span>
                </div>
                <div class="p-4 rounded-2xl shadow-sm border transition-all duration-200
                    {% if msg.is_agent %}
                        bg-oxi-accent/10 border-oxi-accent/20 text-white rounded-tr-none
                        group-hover:shadow-[0_0_20px_rgba(6,182,212,0.1)]
                    {% else %}
                        bg-white/5 border-white/10 text-gray-100 rounded-tl-none
                        group-hover:bg-white/10
                    {% endif %}">
                    <p class="text-sm leading-relaxed whitespace-pre-wrap">{{ msg.content }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Composer -->
    {% include "partials/message_composer.html" %}

    <script>
        function conversationManager() {
            return {
                tags: {{ conversation.tags_json|safe }},
                allTags: {{ all_tags_json|safe }},
                sla: {{ conversation.applied_sla_json|safe }},
                showPicker: false,
                search: '',

                get availableTags() {
                    const currentTagIds = this.tags.map(t => t.id);
                    return this.allTags.filter(t =>
                        !currentTagIds.includes(t.id) &&
                        t.name.toLowerCase().includes(this.search.toLowerCase())
                    );
                },

                async addTag(tagId) {
                    try {
                        const response = await fetch('/api/conversations/{{ conversation.id }}/tags', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ tag_id: tagId })
                        });

                        if (response.ok) {
                            const addedTag = this.allTags.find(t => t.id === tagId);
                            if (addedTag) {
                                this.tags.push(addedTag);
                                this.showPicker = false;
                                this.search = '';

                                window.dispatchEvent(new CustomEvent('toast', {
                                    detail: {
                                        message: `Tag "${addedTag.name}" added`,
                                        type: 'success'
                                    }
                                }));
                            }
                        } else {
                            throw new Error('Failed to add tag');
                        }
                    } catch (error) {
                        console.error('Error adding tag:', error);
                        window.dispatchEvent(new CustomEvent('toast', {
                            detail: {
                                message: 'Failed to add tag',
                                type: 'error'
                            }
                        }));
                    }
                },

                async removeTag(tagId) {
                    try {
                        const response = await fetch(`/api/conversations/{{ conversation.id }}/tags/${tagId}`, {
                            method: 'DELETE'
                        });

                        if (response.ok) {
                            const removedTag = this.tags.find(t => t.id === tagId);
                            this.tags = this.tags.filter(t => t.id !== tagId);

                            if (removedTag) {
                                window.dispatchEvent(new CustomEvent('toast', {
                                    detail: {
                                        message: `Tag "${removedTag.name}" removed`,
                                        type: 'success'
                                    }
                                }));
                            }
                        } else {
                            throw new Error('Failed to remove tag');
                        }
                    } catch (error) {
                        console.error('Error removing tag:', error);
                        window.dispatchEvent(new CustomEvent('toast', {
                            detail: {
                                message: 'Failed to remove tag',
                                type: 'error'
                            }
                        }));
                    }
                }
            };
        }

        function slaTimer(sla) {
            return {
                sla,
                secondsRemaining: 0,

                init() {
                    this.updateTime();
                    // Update every minute
                    setInterval(() => this.updateTime(), 60000);
                },

                updateTime() {
                    // Calculate seconds remaining until first response deadline
                    // For now, using a simple calculation (needs proper implementation)
                    const now = Math.floor(Date.now() / 1000);
                    this.secondsRemaining = this.sla.response_deadline_timestamp - now;
                },

                formatTime() {
                    if (this.secondsRemaining <= 0) {
                        return this.sla.status === 'breached' ? 'SLA Breached' : 'Overdue';
                    }

                    const hours = Math.floor(this.secondsRemaining / 3600);
                    const minutes = Math.floor((this.secondsRemaining % 3600) / 60);

                    if (hours > 24) {
                        const days = Math.floor(hours / 24);
                        return `${days}d ${hours % 24}h`;
                    }

                    if (hours > 0) {
                        return `${hours}h ${minutes}m`;
                    }

                    return `${minutes}m`;
                }
            };
        }
    </script>
</div>