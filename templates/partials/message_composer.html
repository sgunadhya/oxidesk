<div class="p-6 bg-white/5 border-t border-white/5" x-data="macroComposer()">
    <!-- Macro Picker Button -->
    <div class="mb-3 flex justify-between items-center">
        <button @click="showMacroPicker = !showMacroPicker" type="button"
            class="inline-flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-400 hover:text-white bg-white/5 hover:bg-white/10 rounded-xl transition-all duration-200 border border-white/10">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            <span>Quick Macros</span>
        </button>

        <!-- Macro Picker Dropdown -->
        <div x-show="showMacroPicker" @click.away="showMacroPicker = false" x-cloak
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 transform scale-95"
            x-transition:enter-end="opacity-100 transform scale-100"
            x-transition:leave="transition ease-in duration-150"
            x-transition:leave-start="opacity-100 transform scale-100"
            x-transition:leave-end="opacity-0 transform scale-95"
            class="absolute bottom-full left-6 mb-2 w-80 oxi-glass rounded-2xl shadow-2xl z-50 overflow-hidden border border-white/10">

            <!-- Search -->
            <div class="p-4 border-b border-white/10">
                <input x-model="macroSearch" type="text" placeholder="Search macros..."
                    class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-sm text-white placeholder-gray-500 focus:outline-none focus:border-oxi-accent transition-colors duration-200">
            </div>

            <!-- Macro List -->
            <div class="max-h-80 overflow-y-auto custom-scrollbar">
                <template x-if="filteredMacros.length === 0">
                    <div class="px-4 py-8 text-center text-sm text-gray-500">
                        No macros found
                    </div>
                </template>

                <template x-for="macro in filteredMacros" :key="macro.id">
                    <button @click="applyMacro(macro.id)" type="button"
                        class="w-full px-4 py-3 hover:bg-white/5 transition-colors duration-200 text-left border-b border-white/5">
                        <div class="font-medium text-white text-sm" x-text="macro.name"></div>
                        <div class="text-xs text-gray-500 mt-1 line-clamp-2" x-text="macro.description || 'No description'"></div>
                    </button>
                </template>
            </div>
        </div>
    </div>

    <!-- Message Composer Form -->
    <form hx-post="/inbox/c/{{ conversation.id }}/messages" hx-target="#message-list" hx-swap="beforeend"
        @htmx:after-request="if(event.detail.successful) this.reset()">
        <div class="flex gap-3">
            <div class="flex-1 min-w-0">
                <label for="content" class="sr-only">Message</label>
                <textarea id="content" name="content" rows="4" required x-model="messageContent"
                    class="block w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-oxi-accent focus:ring-1 focus:ring-oxi-accent transition-colors duration-200 resize-none"
                    placeholder="Type your reply..."></textarea>
            </div>
            <div class="flex-shrink-0">
                <button type="submit"
                    class="px-6 py-3 bg-oxi-accent text-white rounded-xl hover:bg-oxi-accent/90 transition-all duration-200 font-semibold shadow-[0_0_20px_var(--oxi-accent-glow)]">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </div>
        </div>
    </form>

    <script>
        function macroComposer() {
            return {
                showMacroPicker: false,
                macroSearch: '',
                messageContent: '',
                macros: [],

                async init() {
                    await this.fetchMacros();
                },

                async fetchMacros() {
                    try {
                        const response = await fetch('/api/macros');
                        if (response.ok) {
                            const data = await response.json();
                            this.macros = data.macros || [];
                        }
                    } catch (error) {
                        console.error('Failed to fetch macros:', error);
                    }
                },

                get filteredMacros() {
                    if (!this.macroSearch) return this.macros;
                    const search = this.macroSearch.toLowerCase();
                    return this.macros.filter(m =>
                        m.name.toLowerCase().includes(search) ||
                        (m.description && m.description.toLowerCase().includes(search))
                    );
                },

                async applyMacro(macroId) {
                    try {
                        const response = await fetch(`/api/macros/${macroId}/apply`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                conversation_id: '{{ conversation.id }}'
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();

                            // If macro has a message template, populate the composer
                            if (data.message_content) {
                                this.messageContent = data.message_content;
                            }

                            this.showMacroPicker = false;

                            window.dispatchEvent(new CustomEvent('toast', {
                                detail: {
                                    message: 'Macro applied successfully',
                                    type: 'success'
                                }
                            }));

                            // Reload the conversation to show any actions taken
                            if (data.actions_executed) {
                                setTimeout(() => {
                                    window.location.reload();
                                }, 1000);
                            }
                        } else {
                            throw new Error('Failed to apply macro');
                        }
                    } catch (error) {
                        console.error('Error applying macro:', error);
                        window.dispatchEvent(new CustomEvent('toast', {
                            detail: {
                                message: 'Failed to apply macro',
                                type: 'error'
                            }
                        }));
                    }
                }
            };
        }
    </script>
</div>